[tox]
envlist = 
    py{38,39,310,311,312}
    py{38,39,310,311,312}-redis{6,7}
    integration
    lint
    type-check
    security
    docs
    performance
isolated_build = True
skip_missing_interpreters = True

# Default test environment
[testenv]
deps =
    pytest>=7.0
    pytest-asyncio>=0.21
    pytest-cov>=4.0
    pytest-mock>=3.10
    pytest-xdist>=3.0
    pytest-benchmark>=4.0
    factory-boy>=3.2
    freezegun>=1.2
    responses>=0.22
    
    redis6: redis==4.5.1
    redis7: redis==4.6.0

setenv =
    PYTHONPATH = {toxinidir}
    PYTHONHASHSEED = 0
    PY_COLORS = 1
    
commands =
    pytest tests/unit tests/test_*.py -v --cov=agent_orchestra --cov-report=term-missing {posargs}

# Integration tests requiring external services
[testenv:integration]
deps =
    {[testenv]deps}
    docker-compose>=1.29
    
setenv =
    {[testenv]setenv}
    REDIS_URL = redis://localhost:6379/1
    
commands =
    pytest tests/integration/ -v --cov=agent_orchestra --cov-append {posargs}

# Linting and code style
[testenv:lint]
deps =
    flake8>=5.0
    flake8-docstrings>=1.6
    flake8-bugbear>=22.0
    flake8-comprehensions>=3.10
    flake8-simplify>=0.19
    pydocstyle>=6.1
    
commands =
    flake8 agent_orchestra tests examples --max-line-length=88 --extend-ignore=E203,W503
    pydocstyle agent_orchestra --convention=google

# Type checking
[testenv:type-check]
deps =
    mypy>=1.0
    types-PyYAML>=6.0
    types-redis>=4.0
    types-requests>=2.28
    
commands = 
    mypy agent_orchestra --strict --show-error-codes --show-traceback
    mypy tests --strict --show-error-codes --ignore-missing-imports

# Security scanning
[testenv:security]
deps = 
    bandit[toml]>=1.7
    safety>=2.3
    semgrep>=1.0
    pip-audit>=2.0
    
commands = 
    bandit -r agent_orchestra -f json -o reports/bandit-tox.json
    safety check --json --output reports/safety-tox.json
    pip-audit --format=json --output=reports/pip-audit-tox.json
    semgrep --config=auto --json --output=reports/semgrep-tox.json agent_orchestra/

# Code formatting and style checking
[testenv:format]
deps =
    black>=23.0
    isort>=5.12
    
commands =
    black agent_orchestra tests examples --line-length=88
    isort agent_orchestra tests examples --profile=black

[testenv:format-check]
deps =
    black>=23.0
    isort>=5.12
    
commands =
    black --check agent_orchestra tests examples --line-length=88
    isort --check-only agent_orchestra tests examples --profile=black

# Documentation building
[testenv:docs]
deps = 
    sphinx>=5.0
    sphinx-rtd-theme>=1.2
    myst-parser>=0.18
    sphinx-autodoc-typehints>=1.19
    sphinx-click>=4.3
    
changedir = docs
commands = 
    sphinx-build -W -b html . _build/html
    sphinx-build -W -b doctest . _build/doctest

[testenv:docs-serve]
deps = {[testenv:docs]deps}
changedir = docs
commands = 
    sphinx-build -W -b html . _build/html
    python -m http.server 8000 --directory _build/html

# Performance testing
[testenv:performance]
deps =
    {[testenv]deps}
    memory-profiler>=0.61
    psutil>=5.9
    
commands =
    pytest tests/performance/ -v --benchmark-only --benchmark-json=reports/benchmark.json
    python examples/benchmark.py

# Load testing
[testenv:load]
deps =
    {[testenv]deps}
    locust>=2.0
    
commands =
    python examples/stress_test.py --duration 60

# Package building and validation
[testenv:build]
deps =
    build>=0.10
    twine>=4.0
    check-manifest>=0.49
    
commands =
    check-manifest
    python -m build
    twine check dist/*

# All quality checks combined
[testenv:quality]
deps =
    {[testenv:lint]deps}
    {[testenv:type-check]deps}
    {[testenv:format-check]deps}
    
commands =
    {[testenv:format-check]commands}
    {[testenv:lint]commands}  
    {[testenv:type-check]commands}

# Full test suite (everything except performance)
[testenv:full]
deps =
    {[testenv]deps}
    {[testenv:quality]deps}
    {[testenv:security]deps}
    
commands =
    {[testenv:quality]commands}
    {[testenv]commands}
    {[testenv:integration]commands}
    {[testenv:security]commands}

# Coverage reporting
[testenv:coverage]
deps =
    {[testenv]deps}
    coverage[toml]>=7.0
    
commands =
    coverage erase
    pytest tests/ --cov=agent_orchestra --cov-append
    coverage report --show-missing --fail-under=80
    coverage html
    coverage xml

# Environment for local development
[testenv:dev]
deps =
    {[testenv]deps}
    {[testenv:docs]deps}
    pre-commit>=3.0
    jupyter>=1.0
    ipython>=8.0
    
commands =
    pre-commit install
    python -c "print('Development environment ready!')"

# Flake8 configuration
[flake8]
max-line-length = 88
extend-ignore = E203, W503, E501
exclude = 
    .git,
    __pycache__,
    build,
    dist,
    .eggs,
    *.egg-info,
    .venv,
    venv,
    .tox,
per-file-ignores =
    __init__.py:F401
    tests/*:S101,S106
max-complexity = 10

# Coverage configuration  
[coverage:run]
source = agent_orchestra
branch = true
parallel = true

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    if self.debug:
    if settings.DEBUG
    raise AssertionError
    raise NotImplementedError
    if 0:
    if __name__ == .__main__.:
    class .*\bProtocol\):
    @(abc\.)?abstractmethod